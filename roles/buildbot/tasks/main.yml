---

- name: Install system packages
  sudo: yes
  apt: pkg={{ item.key }} state={{ item.value }}
  with_dict:
    sqlite3: latest
    libsqlite3-dev: latest
    libbz2-dev: latest

- name: Create buildbot user
  user: name=buildbot comment="buildbot user" createhome=yes shell=/bin/bash

- name: Create build app dir
  file: path={{ app_dir }}/buildbot owner=buildbot group=buildbot mode=0755 state=directory

- name: Copy build master requirements
  copy: src=requirements-master.txt dest={{ app_dir }}/buildbot/requirements-master.txt

- name: Create buildbot virtualenv
  shell: "{{ python_dir }}/python{{ python_version }}/bin/virtualenv --python={{ python_dir }}/python{{ python_version }}/bin/python --no-site-packages --distribute buildbot && buildbot/bin/pip install -r {{ app_dir }}/buildbot/requirements-master.txt"
  register: result
  ignore_errors: True
  args:
    chdir: "{{ venv_dir }}"
    creates: "buildbot"

- name: Remove failed buildbot virtualenv
  command: rm -rf buildbot
  when: result|failed
  args:
    chdir: "{{ venv_dir }}"

- name: Create buildbot master base directory
  file: path={{ buildbot_master_dir }} owner=buildbot group=buildbot mode=0755 state=directory

- name: Initialize master
  command: "{{ venv_dir }}/buildbot/bin/buildbot create-master -r {{ buildbot_master_dir }}"
  args:
    creates: "{{ buildbot_master_dir }}/state.sqlite"



